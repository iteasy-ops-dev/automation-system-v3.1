#!/bin/bash

# MCP Service ì‹œì‘ ì „ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸

set -e

echo "ğŸ”§ MCP Integration Service ì‹œì‘ ì¤‘..."

# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸°
echo "ğŸ“¡ PostgreSQL ì—°ê²° ëŒ€ê¸° ì¤‘..."
while ! pg_isready -h ${POSTGRES_HOST:-postgres} -p ${POSTGRES_PORT:-5432} -U ${POSTGRES_USER:-postgres} >/dev/null 2>&1; do
  echo "â³ PostgreSQL ì—°ê²° ëŒ€ê¸° ì¤‘... (5ì´ˆ í›„ ì¬ì‹œë„)"
  sleep 5
done

echo "âœ… PostgreSQL ì—°ê²° í™•ì¸"

# MCP í•„ìˆ˜ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ì¶”ê°€
echo "ğŸ”„ MCP í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸ ì¤‘..."

# í•„ìˆ˜ ì»¬ëŸ¼ ì²´í¬ ë° ì¶”ê°€
PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
  -h ${POSTGRES_HOST:-postgres} \
  -p ${POSTGRES_PORT:-5432} \
  -U ${POSTGRES_USER:-postgres} \
  -d ${POSTGRES_DB:-automation} \
  -c "
-- MCP Protocol í‘œì¤€ ì»¬ëŸ¼ë“¤ ì¶”ê°€ (IF NOT EXISTSë¡œ ì•ˆì „í•˜ê²Œ)
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS connection_status VARCHAR(20) DEFAULT 'disconnected';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS transport VARCHAR(20) DEFAULT 'stdio';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS command VARCHAR(500);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS args TEXT[] DEFAULT '{}';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS ssh_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS docker_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS http_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS server_info JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_error TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';

-- ê¸°ì¡´ NOT NULL ì œì•½ ì¡°ê±´ ì™„í™”
DO \$\$ BEGIN
  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN endpoint_url DROP NOT NULL;
  EXCEPTION
    WHEN others THEN NULL;
  END;
  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN server_type DROP NOT NULL;
  EXCEPTION
    WHEN others THEN NULL;
  END;
END \$\$;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX IF NOT EXISTS idx_mcp_servers_transport ON mcp_servers(transport);
CREATE INDEX IF NOT EXISTS idx_mcp_servers_connection_status ON mcp_servers(connection_status);
" || echo "âš ï¸ ì¼ë¶€ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •ì´ ìŠ¤í‚µë˜ì—ˆìŠµë‹ˆë‹¤ (ì´ë¯¸ ì ìš©ë¨)"

# Prisma Client ì¬ìƒì„±
echo "ğŸ”„ Prisma Client ì¬ìƒì„± ì¤‘..."
npx prisma generate

echo "âœ… MCP ìŠ¤í‚¤ë§ˆ í™•ì¸ ì™„ë£Œ"

# MCP Service ì‹œì‘
echo "ğŸš€ MCP Integration Service ì‹œì‘..."
exec npm start
