#!/bin/bash

# MCP Service 시작 전 데이터베이스 확인 스크립트

set -e

echo "🔧 MCP Integration Service 시작 중..."

# 데이터베이스 연결 대기
echo "📡 PostgreSQL 연결 대기 중..."
while ! pg_isready -h ${POSTGRES_HOST:-postgres} -p ${POSTGRES_PORT:-5432} -U ${POSTGRES_USER:-postgres} >/dev/null 2>&1; do
  echo "⏳ PostgreSQL 연결 대기 중... (5초 후 재시도)"
  sleep 5
done

echo "✅ PostgreSQL 연결 확인"

# MCP 필수 컬럼 존재 여부 확인 및 추가
echo "🔄 MCP 테이블 스키마 확인 중..."

# 필수 컬럼 체크 및 추가
PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
  -h ${POSTGRES_HOST:-postgres} \
  -p ${POSTGRES_PORT:-5432} \
  -U ${POSTGRES_USER:-postgres} \
  -d ${POSTGRES_DB:-automation} \
  -c "
-- MCP Protocol 표준 컬럼들 추가 (IF NOT EXISTS로 안전하게)
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS connection_status VARCHAR(20) DEFAULT 'disconnected';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS transport VARCHAR(20) DEFAULT 'stdio';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS command VARCHAR(500);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS args TEXT[] DEFAULT '{}';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS ssh_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS docker_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS http_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS server_info JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_error TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';

-- 기존 NOT NULL 제약 조건 완화
DO \$\$ BEGIN
  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN endpoint_url DROP NOT NULL;
  EXCEPTION
    WHEN others THEN NULL;
  END;
  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN server_type DROP NOT NULL;
  EXCEPTION
    WHEN others THEN NULL;
  END;
END \$\$;

-- 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_mcp_servers_transport ON mcp_servers(transport);
CREATE INDEX IF NOT EXISTS idx_mcp_servers_connection_status ON mcp_servers(connection_status);
" || echo "⚠️ 일부 스키마 수정이 스킵되었습니다 (이미 적용됨)"

# Prisma Client 재생성
echo "🔄 Prisma Client 재생성 중..."
npx prisma generate

echo "✅ MCP 스키마 확인 완료"

# MCP Service 시작
echo "🚀 MCP Integration Service 시작..."
exec npm start
