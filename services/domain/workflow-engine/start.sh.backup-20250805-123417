#!/bin/bash

# Workflow Engine + n8n ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
set -e

echo "ğŸš€ Starting Workflow Engine Service with n8n..."

# í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
if [ -z "$DATABASE_URL" ]; then
    echo "âŒ DATABASE_URL environment variable is required"
    exit 1
fi

# Prisma ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
echo "ğŸ” Checking database connection..."
npx prisma db push --accept-data-loss || {
    echo "âŒ Database connection failed"
    exit 1
}

echo "âœ… Database connection verified"

# n8nì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘
echo "ğŸ“¦ Starting n8n on port 5678..."
n8n start &
N8N_PID=$!

# n8nì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
echo "â³ Waiting for n8n to be ready..."
for i in {1..30}; do
    if curl -f http://localhost:5678/healthz >/dev/null 2>&1; then
        echo "âœ… n8n is ready (attempt $i/30)"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ n8n failed to start within 30 seconds"
        kill $N8N_PID 2>/dev/null || true
        exit 1
    fi
    sleep 1
done

# n8n í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
if ! kill -0 $N8N_PID 2>/dev/null; then
    echo "âŒ n8n process died"
    exit 1
fi

echo "âœ… n8n started successfully (PID: $N8N_PID)"

# Workflow Engine ì„œë¹„ìŠ¤ ì‹œì‘
echo "ğŸ”§ Starting Workflow Engine Service on port 8401..."
exec npm start

# execë¥¼ ì‚¬ìš©í•˜ì—¬ PID 1ìœ¼ë¡œ ì‹¤í–‰ (ì‹ í˜¸ ì²˜ë¦¬ ê°œì„ )