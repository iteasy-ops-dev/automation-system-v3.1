#!/bin/bash

# Storage Service ì™„ì „í•œ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
# TASK-4-PRISMA ì˜êµ¬ í•´ê²°ì±…

set -e

echo "ğŸš€ Storage Service ì‹œì‘ ì¤‘..."
echo "ğŸ“… $(date)"

# í™˜ê²½ë³€ìˆ˜ í™•ì¸
echo "ğŸ” í™˜ê²½ë³€ìˆ˜ í™•ì¸:"
echo "  - POSTGRES_HOST: ${POSTGRES_HOST:-postgres}"
echo "  - POSTGRES_PORT: ${POSTGRES_PORT:-5432}"
echo "  - POSTGRES_DB: ${POSTGRES_DB:-automation}"
echo "  - POSTGRES_USER: ${POSTGRES_USER:-postgres}"

# PostgreSQL ì—°ê²° ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
echo "ğŸ“¡ PostgreSQL ì—°ê²° ëŒ€ê¸° ì¤‘..."
TIMEOUT=60
ELAPSED=0

while ! pg_isready -h ${POSTGRES_HOST:-postgres} -p ${POSTGRES_PORT:-5432} -U ${POSTGRES_USER:-postgres} >/dev/null 2>&1; do
  if [ $ELAPSED -ge $TIMEOUT ]; then
    echo "âŒ PostgreSQL ì—°ê²° ì‹¤íŒ¨: ${TIMEOUT}ì´ˆ ì´ˆê³¼"
    exit 1
  fi
  echo "â³ PostgreSQL ì—°ê²° ëŒ€ê¸° ì¤‘... (${ELAPSED}/${TIMEOUT}ì´ˆ)"
  sleep 5
  ELAPSED=$((ELAPSED + 5))
done

echo "âœ… PostgreSQL ì—°ê²° í™•ì¸ (${ELAPSED}ì´ˆ ì†Œìš”)"

# ë°ì´í„°ë² ì´ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
echo "ğŸ” ë°ì´í„°ë² ì´ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸..."
DB_EXISTS=$(PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
  -h ${POSTGRES_HOST:-postgres} \
  -p ${POSTGRES_PORT:-5432} \
  -U ${POSTGRES_USER:-postgres} \
  -lqt | cut -d \| -f 1 | grep -w ${POSTGRES_DB:-automation} | wc -l)

if [ "$DB_EXISTS" -eq "0" ]; then
  echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ '${POSTGRES_DB:-automation}'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
  exit 1
fi

echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ '${POSTGRES_DB:-automation}' í™•ì¸"

# MCP í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
echo "ğŸ” MCP í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸..."
MCP_TABLE_EXISTS=$(PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
  -h ${POSTGRES_HOST:-postgres} \
  -p ${POSTGRES_PORT:-5432} \
  -U ${POSTGRES_USER:-postgres} \
  -d ${POSTGRES_DB:-automation} \
  -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'mcp_servers');" \
  -t | tr -d ' \n')

if [ "$MCP_TABLE_EXISTS" = "f" ]; then
  echo "âŒ mcp_servers í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
  exit 1
fi

echo "âœ… mcp_servers í…Œì´ë¸” í™•ì¸"

# MCP í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ ë° ì¶”ê°€
echo "ğŸ”„ MCP í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì¤‘..."

PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
  -h ${POSTGRES_HOST:-postgres} \
  -p ${POSTGRES_PORT:-5432} \
  -U ${POSTGRES_USER:-postgres} \
  -d ${POSTGRES_DB:-automation} \
  -c "
-- MCP Protocol í‘œì¤€ ì»¬ëŸ¼ë“¤ ì¶”ê°€ (ì•ˆì „í•˜ê²Œ)
DO \$\$
BEGIN
  -- connection_status ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN connection_status VARCHAR(20) DEFAULT 'disconnected';
    RAISE NOTICE 'connection_status ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'connection_status ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- transport ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN transport VARCHAR(20) DEFAULT 'stdio';
    RAISE NOTICE 'transport ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'transport ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- command ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN command VARCHAR(500);
    RAISE NOTICE 'command ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'command ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- args ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN args TEXT[] DEFAULT '{}';
    RAISE NOTICE 'args ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'args ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- ssh_config ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN ssh_config JSONB;
    RAISE NOTICE 'ssh_config ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'ssh_config ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- docker_config ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN docker_config JSONB;
    RAISE NOTICE 'docker_config ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'docker_config ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- http_config ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN http_config JSONB;
    RAISE NOTICE 'http_config ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'http_config ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- server_info ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN server_info JSONB;
    RAISE NOTICE 'server_info ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'server_info ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- last_error ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN last_error TEXT;
    RAISE NOTICE 'last_error ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'last_error ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- metadata ì»¬ëŸ¼ ì¶”ê°€
  BEGIN
    ALTER TABLE mcp_servers ADD COLUMN metadata JSONB DEFAULT '{}';
    RAISE NOTICE 'metadata ì»¬ëŸ¼ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_column THEN
      RAISE NOTICE 'metadata ì»¬ëŸ¼ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  -- NOT NULL ì œì•½ ì¡°ê±´ ì œê±°
  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN endpoint_url DROP NOT NULL;
    RAISE NOTICE 'endpoint_url NOT NULL ì œì•½ ì¡°ê±´ ì œê±°ë¨';
  EXCEPTION
    WHEN others THEN
      RAISE NOTICE 'endpoint_url NOT NULL ì œì•½ ì¡°ê±´ ì œê±° ìŠ¤í‚µë¨';
  END;

  BEGIN
    ALTER TABLE mcp_servers ALTER COLUMN server_type DROP NOT NULL;
    RAISE NOTICE 'server_type NOT NULL ì œì•½ ì¡°ê±´ ì œê±°ë¨';
  EXCEPTION
    WHEN others THEN
      RAISE NOTICE 'server_type NOT NULL ì œì•½ ì¡°ê±´ ì œê±° ìŠ¤í‚µë¨';
  END;

END
\$\$;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX IF NOT EXISTS idx_mcp_servers_transport ON mcp_servers(transport);
CREATE INDEX IF NOT EXISTS idx_mcp_servers_connection_status ON mcp_servers(connection_status);

-- ì œì•½ ì¡°ê±´ ì¶”ê°€ (ì•ˆì „í•˜ê²Œ)
DO \$\$
BEGIN
  BEGIN
    ALTER TABLE mcp_servers ADD CONSTRAINT mcp_servers_connection_status_check 
      CHECK (connection_status::text = ANY (ARRAY['connected'::character varying, 'disconnected'::character varying, 'connecting'::character varying, 'error'::character varying]::text[]));
    RAISE NOTICE 'connection_status ì²´í¬ ì œì•½ ì¡°ê±´ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_object THEN
      RAISE NOTICE 'connection_status ì²´í¬ ì œì•½ ì¡°ê±´ ì´ë¯¸ ì¡´ì¬í•¨';
  END;

  BEGIN
    ALTER TABLE mcp_servers ADD CONSTRAINT mcp_servers_transport_check 
      CHECK (transport::text = ANY (ARRAY['stdio'::character varying, 'ssh'::character varying, 'docker'::character varying, 'http'::character varying]::text[]));
    RAISE NOTICE 'transport ì²´í¬ ì œì•½ ì¡°ê±´ ì¶”ê°€ë¨';
  EXCEPTION
    WHEN duplicate_object THEN
      RAISE NOTICE 'transport ì²´í¬ ì œì•½ ì¡°ê±´ ì´ë¯¸ ì¡´ì¬í•¨';
  END;
END
\$\$;
" 2>&1 | while IFS= read -r line; do
  echo "  ğŸ“ $line"
done

echo "âœ… MCP ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

# Prisma Client ì¬ìƒì„±
echo "ğŸ”„ Prisma Client ì¬ìƒì„± ì¤‘..."
npx prisma generate

echo "âœ… Prisma Client ì¬ìƒì„± ì™„ë£Œ"

# ìµœì¢… ìŠ¤í‚¤ë§ˆ ê²€ì¦
echo "ğŸ” ìµœì¢… ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì¤‘..."
REQUIRED_COLUMNS=("connection_status" "transport" "command" "args" "ssh_config" "docker_config" "http_config" "server_info" "last_error" "metadata")

for column in "${REQUIRED_COLUMNS[@]}"; do
  COLUMN_EXISTS=$(PGPASSWORD=${POSTGRES_PASSWORD:-password} psql \
    -h ${POSTGRES_HOST:-postgres} \
    -p ${POSTGRES_PORT:-5432} \
    -U ${POSTGRES_USER:-postgres} \
    -d ${POSTGRES_DB:-automation} \
    -c "SELECT EXISTS (SELECT FROM information_schema.columns WHERE table_name='mcp_servers' AND column_name='$column');" \
    -t | tr -d ' \n')
  
  if [ "$COLUMN_EXISTS" = "t" ]; then
    echo "  âœ… $column ì»¬ëŸ¼ í™•ì¸"
  else
    echo "  âŒ $column ì»¬ëŸ¼ ëˆ„ë½"
    exit 1
  fi
done

echo "âœ… ëª¨ë“  í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ ì™„ë£Œ"

# Storage Service ì‹œì‘
echo "ğŸš€ Storage Service ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘..."
echo "ğŸ“… $(date)"

exec npm start