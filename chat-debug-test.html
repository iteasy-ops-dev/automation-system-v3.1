<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Debug Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .success { border-color: #4ade80; background: #f0fdf4; }
        .error { border-color: #f87171; background: #fef2f2; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        textarea { height: 60px; resize: vertical; }
        h2 { color: #1f2937; margin-top: 0; }
        h3 { color: #374151; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Chat Debug Test - í†µí•© ìë™í™” ì‹œìŠ¤í…œ v3.1</h1>
        
        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div class="test-section" id="auth-section">
            <h2>1. ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h2>
            <input type="text" id="username" placeholder="Username" value="admin">
            <input type="password" id="password" placeholder="Password" value="Admin123!@#">
            <button class="btn-primary" onclick="testLogin()">ë¡œê·¸ì¸</button>
            <div class="result" id="auth-result">ë¡œê·¸ì¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>

        <!-- API ì—°ê²° í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="api-section">
            <h2>2. API ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
            <button class="btn-primary" onclick="testAPIs()">ëª¨ë“  API í…ŒìŠ¤íŠ¸</button>
            <div class="result" id="api-result">API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>

        <!-- WebSocket í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="ws-section">
            <h2>3. WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
            <button class="btn-primary" onclick="testWebSocket()">WebSocket ì—°ê²°</button>
            <button class="btn-primary" onclick="disconnectWebSocket()">ì—°ê²° í•´ì œ</button>
            <div class="result" id="ws-result">ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>

        <!-- ì±„íŒ… ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="chat-section">
            <h2>4. ì±„íŒ… ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h2>
            <textarea id="chat-message" placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">ì‹œìŠ¤í…œ ì •ë³´ë¥¼ í™•ì¸í•´ì¤˜</textarea>
            <button class="btn-success" onclick="testChatWorkflow()">ì±„íŒ… ì „ì†¡</button>
            <div class="result" id="chat-result">ì±„íŒ… ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>

        <!-- MCP ë„êµ¬ ì§ì ‘ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="mcp-section">
            <h2>5. MCP ë„êµ¬ ì§ì ‘ í…ŒìŠ¤íŠ¸</h2>
            <select id="mcp-tool">
                <option value="get_config">get_config (ì‹œìŠ¤í…œ ì„¤ì •)</option>
                <option value="list_processes">list_processes (í”„ë¡œì„¸ìŠ¤ ëª©ë¡)</option>
                <option value="list_directory">list_directory (ë””ë ‰í† ë¦¬ ëª©ë¡)</option>
            </select>
            <input type="text" id="mcp-params" placeholder="Parameters (JSON)" value="{}">
            <button class="btn-success" onclick="testMCPTool()">MCP ë„êµ¬ ì‹¤í–‰</button>
            <div class="result" id="mcp-result">MCP ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        let authToken = null;
        let socket = null;

        // ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        async function testLogin() {
            const resultDiv = document.getElementById('auth-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                resultDiv.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                const response = await fetch('http://localhost:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok && data.accessToken) {
                    authToken = data.accessToken;
                    resultDiv.textContent = `âœ… ë¡œê·¸ì¸ ì„±ê³µ!\nToken: ${authToken.substring(0, 50)}...\nUser: ${data.user.username} (${data.user.role})`;
                    document.getElementById('auth-section').className = 'test-section success';
                } else {
                    throw new Error(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                }
            } catch (error) {
                resultDiv.textContent = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                document.getElementById('auth-section').className = 'test-section error';
            }
        }

        // API ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testAPIs() {
            const resultDiv = document.getElementById('api-result');
            
            if (!authToken) {
                resultDiv.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                return;
            }

            resultDiv.textContent = 'API í…ŒìŠ¤íŠ¸ ì¤‘...';
            const results = [];

            const tests = [
                { name: 'LLM Models', url: '/api/v1/llm/models' },
                { name: 'MCP Servers', url: '/api/v1/mcp/servers' },
                { name: 'Device List', url: '/api/v1/devices' },
                { name: 'Workflow Health', url: '/api/v1/workflows/health' }
            ];

            for (const test of tests) {
                try {
                    const response = await fetch(`http://localhost:8080${test.url}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (response.ok) {
                        results.push(`âœ… ${test.name}: OK`);
                    } else {
                        const error = await response.text();
                        results.push(`âŒ ${test.name}: ${response.status} - ${error.substring(0, 100)}`);
                    }
                } catch (error) {
                    results.push(`âŒ ${test.name}: ${error.message}`);
                }
            }

            resultDiv.textContent = results.join('\n');
            
            if (results.every(r => r.startsWith('âœ…'))) {
                document.getElementById('api-section').className = 'test-section success';
            } else {
                document.getElementById('api-section').className = 'test-section error';
            }
        }

        // WebSocket í…ŒìŠ¤íŠ¸
        function testWebSocket() {
            const resultDiv = document.getElementById('ws-result');
            
            if (!authToken) {
                resultDiv.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                return;
            }

            try {
                resultDiv.textContent = 'WebSocket ì—°ê²° ì¤‘...';
                
                // Socket.IO ì—°ê²°
                socket = io('http://localhost:8080', {
                    path: '/ws',
                    auth: { token: authToken },
                    extraHeaders: { 'Authorization': `Bearer ${authToken}` }
                });

                socket.on('connect', () => {
                    resultDiv.textContent = 'âœ… WebSocket ì—°ê²° ì„±ê³µ!\nSession ID: ' + socket.id;
                    document.getElementById('ws-section').className = 'test-section success';
                });

                socket.on('disconnect', (reason) => {
                    resultDiv.textContent = 'âŒ WebSocket ì—°ê²° í•´ì œ: ' + reason;
                    document.getElementById('ws-section').className = 'test-section error';
                });

                socket.on('connect_error', (error) => {
                    resultDiv.textContent = 'âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error.message;
                    document.getElementById('ws-section').className = 'test-section error';
                });

                // ë©”ì‹œì§€ ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
                socket.on('workflow_progress', (data) => {
                    resultDiv.textContent += '\nğŸ“¨ Progress: ' + JSON.stringify(data, null, 2);
                });

                socket.on('chat_response', (data) => {
                    resultDiv.textContent += '\nğŸ’¬ Response: ' + JSON.stringify(data, null, 2);
                });

            } catch (error) {
                resultDiv.textContent = 'âŒ WebSocket ì˜¤ë¥˜: ' + error.message;
                document.getElementById('ws-section').className = 'test-section error';
            }
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        // ì±„íŒ… ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
        async function testChatWorkflow() {
            const resultDiv = document.getElementById('chat-result');
            const message = document.getElementById('chat-message').value;
            
            if (!authToken) {
                resultDiv.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                return;
            }

            try {
                resultDiv.textContent = 'ì±„íŒ… ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘...';
                
                const response = await fetch('http://localhost:8080/api/v1/workflows/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: '123e4567-e89b-12d3-a456-426614174000'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `âœ… ì±„íŒ… ì›Œí¬í”Œë¡œìš° ì„±ê³µ!\n\nì‘ë‹µ: ${data.message}\n\nìƒì„¸:\n${JSON.stringify(data, null, 2)}`;
                    document.getElementById('chat-section').className = 'test-section success';
                } else {
                    throw new Error(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                resultDiv.textContent = `âŒ ì±„íŒ… ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨:\n${error.message}`;
                document.getElementById('chat-section').className = 'test-section error';
            }
        }

        // MCP ë„êµ¬ ì§ì ‘ í…ŒìŠ¤íŠ¸
        async function testMCPTool() {
            const resultDiv = document.getElementById('mcp-result');
            const tool = document.getElementById('mcp-tool').value;
            const paramsText = document.getElementById('mcp-params').value;
            
            if (!authToken) {
                resultDiv.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                return;
            }

            try {
                resultDiv.textContent = 'MCP ë„êµ¬ ì‹¤í–‰ ì¤‘...';
                
                let parameters = {};
                if (paramsText.trim()) {
                    parameters = JSON.parse(paramsText);
                }

                const response = await fetch('http://localhost:8080/api/v1/mcp/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        serverId: 'cbda6dfa-78a7-41a3-9986-869239873a72',
                        tool: tool,
                        parameters: parameters
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `âœ… MCP ë„êµ¬ ì‹¤í–‰ ì„±ê³µ!\n\nê²°ê³¼:\n${JSON.stringify(data, null, 2)}`;
                    document.getElementById('mcp-section').className = 'test-section success';
                } else {
                    throw new Error(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                resultDiv.textContent = `âŒ MCP ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨:\n${error.message}`;
                document.getElementById('mcp-section').className = 'test-section error';
            }
        }

        // Socket.io ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
        const socketScript = document.createElement('script');
        socketScript.src = 'https://cdn.socket.io/socket.io-4.5.0.min.js';
        document.head.appendChild(socketScript);
    </script>
</body>
</html>