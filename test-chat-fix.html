<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .chat-container { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .user { background: #007bff; color: white; margin-left: 50px; }
        .assistant { background: #e9ecef; margin-right: 50px; }
        .error { background: #dc3545; color: white; }
        input { width: 70%; padding: 10px; }
        button { padding: 10px 20px; margin-left: 10px; }
        .status { margin: 10px 0; font-weight: bold; }
        .success { color: green; }
        .error-status { color: red; }
        .debug { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Chat API ìˆ˜ì • í…ŒìŠ¤íŠ¸</h1>
    
    <div id="status" class="status">ìƒíƒœ: ì¤€ë¹„ë¨</div>
    
    <div id="chatContainer" class="chat-container">
        <div class="message assistant">ì•ˆë…•í•˜ì„¸ìš”! ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</div>
    </div>
    
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
    <button onclick="sendMessage()">ì „ì†¡</button>
    <button onclick="clearChat()">ì´ˆê¸°í™”</button>
    <button onclick="testDirectAPI()">ì§ì ‘ API í…ŒìŠ¤íŠ¸</button>
    
    <h3>í…ŒìŠ¤íŠ¸ í˜„í™©</h3>
    <ul>
        <li>âœ… ë°±ì—”ë“œ API: ì •ìƒ ì‘ë™ (/api/v1/workflows/chat)</li>
        <li>ğŸ”¥ í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •: ChatContainer.tsx ì‘ë‹µ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€</li>
        <li>ğŸ§ª í˜„ì¬ í…ŒìŠ¤íŠ¸: UIì— AI ì‘ë‹µì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸</li>
    </ul>

    <div id="debugInfo" class="debug" style="display: none;">
        <h4>ë””ë²„ê·¸ ì •ë³´</h4>
        <div id="debugContent"></div>
    </div>

    <script>
        let sessionId = 'test-' + Date.now();
        let authToken = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œê·¸ì¸
        window.onload = function() {
            getAuthToken();
        };

        // ë¡œê·¸ì¸í•˜ì—¬ í† í° íšë“
        async function getAuthToken() {
            try {
                updateStatus('ë¡œê·¸ì¸ ì¤‘...', 'success');
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Admin123!@#'
                    })
                });
                
                const data = await response.json();
                authToken = data.accessToken;
                updateStatus('ë¡œê·¸ì¸ ì„±ê³µ âœ…', 'success');
                return true;
            } catch (error) {
                updateStatus('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error-status');
                return false;
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!authToken) {
                await getAuthToken();
                if (!authToken) return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', message);
            input.value = '';
            updateStatus('AI ì‘ë‹µ ëŒ€ê¸° ì¤‘...', 'success');

            try {
                const response = await fetch('/api/v1/workflows/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
                showDebugInfo(data);
                
                // ğŸ”¥ í•µì‹¬ í…ŒìŠ¤íŠ¸: API ì‘ë‹µì— message í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                if (data.message) {
                    addMessage('assistant', data.message);
                    updateStatus(`âœ… ì„±ê³µ! AI ì‘ë‹µ ë°›ìŒ (${data.type || 'unknown'})`, 'success');
                } else {
                    addMessage('error', 'âš ï¸ API ì‘ë‹µì— message í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    updateStatus('âŒ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜', 'error-status');
                }

            } catch (error) {
                addMessage('error', 'âŒ ì˜¤ë¥˜: ' + error.message);
                updateStatus('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + error.message, 'error-status');
            }
        }

        // ì§ì ‘ API í…ŒìŠ¤íŠ¸
        async function testDirectAPI() {
            if (!authToken) {
                await getAuthToken();
                if (!authToken) return;
            }

            updateStatus('ì§ì ‘ API í…ŒìŠ¤íŠ¸ ì¤‘...', 'success');

            try {
                const response = await fetch('/api/v1/workflows/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        message: 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤'
                    })
                });

                const data = await response.json();
                
                // ê²°ê³¼ ë¶„ì„
                console.log('ğŸ” Direct API Test Result:', data);
                showDebugInfo(data);
                
                const hasMessage = !!data.message;
                const messageContent = data.message || 'N/A';
                
                addMessage('assistant', `ğŸ“Š API í…ŒìŠ¤íŠ¸ ê²°ê³¼:
â€¢ Status: ${response.status}
â€¢ Message í•„ë“œ ì¡´ì¬: ${hasMessage ? 'âœ… YES' : 'âŒ NO'}
â€¢ Message ë‚´ìš©: ${messageContent}
â€¢ Type: ${data.type || 'N/A'}
â€¢ ExecutionId: ${data.executionId || 'N/A'}`);

                updateStatus(hasMessage ? 'âœ… API í…ŒìŠ¤íŠ¸ ì„±ê³µ' : 'âŒ Message í•„ë“œ ì—†ìŒ', hasMessage ? 'success' : 'error-status');

            } catch (error) {
                addMessage('error', 'âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                updateStatus('âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error-status');
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content.replace(/\n/g, '<br>');
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = `ìƒíƒœ: ${message}`;
            status.className = `status ${className}`;
        }

        // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
        function showDebugInfo(data) {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            debugContent.innerHTML = `
                <strong>Raw API Response:</strong><br>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            debugDiv.style.display = 'block';
        }

        // ì±„íŒ… ì´ˆê¸°í™”
        function clearChat() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '<div class="message assistant">ì•ˆë…•í•˜ì„¸ìš”! ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</div>';
            
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = 'none';
            
            updateStatus('ì±„íŒ… ì´ˆê¸°í™”ë¨', 'success');
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>