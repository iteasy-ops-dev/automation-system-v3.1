#!/bin/bash

# ========================================
# ì™„ë²½í•œ ë³µì› ìŠ¤í¬ë¦½íŠ¸ v2.0
# Prisma ìŠ¤í‚¤ë§ˆì™€ DB ìŠ¤í‚¤ë§ˆ ì™„ì „ ë™ê¸°í™” í¬í•¨
# ========================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# í•¨ìˆ˜: ë¡œê·¸ ì¶œë ¥
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# ë°±ì—… ë””ë ‰í† ë¦¬ ì°¾ê¸°
PROJECT_DIR="/Users/leesg/Documents/work_ops/automation-system"
BACKUP_DIR=""

# ìµœì‹  ë°±ì—… ì°¾ê¸° (20250802_165334 ìš°ì„ )
if [ -d "$PROJECT_DIR/backups/20250802_165334" ]; then
    BACKUP_DIR="$PROJECT_DIR/backups/20250802_165334"
    log_info "ê²€ì¦ëœ ë°±ì—… ì‚¬ìš©: 20250802_165334"
else
    # ê°€ì¥ ìµœê·¼ ë°±ì—… ì°¾ê¸°
    BACKUP_DIR=$(ls -dt $PROJECT_DIR/backups/202* 2>/dev/null | head -1)
    if [ -z "$BACKUP_DIR" ]; then
        log_error "ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        exit 1
    fi
    log_info "ë°±ì—… ì‚¬ìš©: $(basename $BACKUP_DIR)"
fi

echo ""
echo "========================================="
echo "   ì™„ë²½í•œ ì‹œìŠ¤í…œ ë³µì› v2.0"
echo "========================================="
echo "ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo "í”„ë¡œì íŠ¸: $PROJECT_DIR"
echo "========================================="
echo ""

# 1. ì‹œìŠ¤í…œ ì™„ì „ ì¤‘ì§€
log_info "1ë‹¨ê³„: ê¸°ì¡´ ì‹œìŠ¤í…œ ì™„ì „ ì¤‘ì§€..."
cd "$PROJECT_DIR"
docker-compose down 2>/dev/null || true
log_success "ì‹œìŠ¤í…œ ì¤‘ì§€ ì™„ë£Œ"
echo ""

# 2. Docker ì´ë¯¸ì§€ ë³µì›
log_info "2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë³µì›..."
cd "$BACKUP_DIR/images"
for image_file in *.tar; do
    if [ -f "$image_file" ]; then
        echo "  â†’ $image_file ë³µì› ì¤‘..."
        docker load -i "$image_file" > /dev/null 2>&1
    fi
done
log_success "Docker ì´ë¯¸ì§€ ë³µì› ì™„ë£Œ"
echo ""

# 3. ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
log_info "3ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘..."
cd "$PROJECT_DIR"
docker-compose up -d postgres mongodb redis minio influxdb
sleep 15
log_success "ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
echo ""

# 4. PostgreSQL ì´ˆê¸°í™” ë° í™•ì¥ ì„¤ì¹˜
log_info "4ë‹¨ê³„: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„..."

# ë°ì´í„°ë² ì´ìŠ¤ ì¬ìƒì„±
docker exec automation-postgres psql -U postgres -c "DROP DATABASE IF EXISTS automation" 2>/dev/null || true
docker exec automation-postgres psql -U postgres -c "CREATE DATABASE automation"

# í•„ìˆ˜ í™•ì¥ ì„¤ì¹˜ (Prismaê°€ resetí•´ë„ ìœ ì§€ë˜ë„ë¡)
docker exec automation-postgres psql -U postgres -d automation << 'EOF'
-- í•„ìˆ˜ í™•ì¥ ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS btree_gin;
EOF

log_success "PostgreSQL ì¤€ë¹„ ì™„ë£Œ"
echo ""

# 5. ë°±ì—… ë°ì´í„° ë³µì›
log_info "5ë‹¨ê³„: ë°±ì—… ë°ì´í„° ë³µì›..."

# PostgreSQL ë°ì´í„° ë³µì›
if [ -f "$BACKUP_DIR/data/postgres-full-20250802_165334.sql" ]; then
    cat "$BACKUP_DIR/data/postgres-full-20250802_165334.sql" | docker exec -i automation-postgres psql -U postgres -d automation 2>/dev/null
else
    log_warning "PostgreSQL ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µ..."
fi

# MongoDB ë°ì´í„° ë³µì›
if [ -f "$BACKUP_DIR/data/mongodb-20250802_165334.archive" ]; then
    docker exec -i automation-mongodb mongorestore --archive --db=automation \
        --username=admin --password=automation_mongo_pass_2024 \
        --authenticationDatabase=admin --drop < "$BACKUP_DIR/data/mongodb-20250802_165334.archive" 2>/dev/null
else
    log_warning "MongoDB ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µ..."
fi

log_success "ë°ì´í„° ë³µì› ì™„ë£Œ"
echo ""

# 6. Prisma ìŠ¤í‚¤ë§ˆì™€ DB ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” (í•µì‹¬!)
log_info "6ë‹¨ê³„: Prisma-DB ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”..."

# ëˆ„ë½ëœ ì»¬ëŸ¼ ì¶”ê°€ (Prisma ìŠ¤í‚¤ë§ˆ ê¸°ì¤€)
docker exec automation-postgres psql -U postgres -d automation << 'EOF'
-- devices í…Œì´ë¸” ìˆ˜ì •
ALTER TABLE devices ADD COLUMN IF NOT EXISTS connection_info jsonb DEFAULT '{}'::jsonb;

-- mcp_servers í…Œì´ë¸” ìˆ˜ì •
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS transport VARCHAR(20) DEFAULT 'stdio';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS connection_status VARCHAR(20) DEFAULT 'disconnected';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS command VARCHAR(500);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS args TEXT[] DEFAULT ARRAY[]::TEXT[];
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS ssh_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS docker_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS http_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS server_info JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_error TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS environment JSONB DEFAULT '{}'::jsonb;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}'::jsonb;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_connected_at TIMESTAMP(6);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS error_message TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;

-- mcp_tools í…Œì´ë¸” ìƒì„± (ì—†ëŠ” ê²½ìš°)
CREATE TABLE IF NOT EXISTS mcp_tools (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    server_id UUID NOT NULL REFERENCES mcp_servers(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    input_schema jsonb DEFAULT '{}'::jsonb,
    output_schema jsonb DEFAULT '{}'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(server_id, name)
);

-- mcp_executions í…Œì´ë¸” ìƒì„± (ì—†ëŠ” ê²½ìš°)
CREATE TABLE IF NOT EXISTS mcp_executions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    server_id UUID NOT NULL REFERENCES mcp_servers(id) ON DELETE CASCADE,
    tool_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    input_params jsonb DEFAULT '{}'::jsonb,
    output_result jsonb,
    error_message TEXT,
    started_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP(6),
    duration_ms INTEGER,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by UUID,
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP
);
EOF

log_success "ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ì™„ë£Œ"
echo ""

# 7. ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘
log_info "7ë‹¨ê³„: ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘..."
cd "$PROJECT_DIR"

# Kafka/Zookeeper ì‹œì‘
docker-compose up -d zookeeper kafka
sleep 10

# Core ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose up -d storage gateway
sleep 5

# Domain ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose up -d device-service mcp-service llm-service workflow-engine
sleep 5

# Frontend ì‹œì‘
docker-compose up -d main-app

log_success "ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
echo ""

# 8. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
log_info "8ë‹¨ê³„: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
sleep 10

echo ""
echo "========================================="
echo "   ì„œë¹„ìŠ¤ ìƒíƒœ"
echo "========================================="
docker ps --format "table {{.Names}}\t{{.Status}}" | grep automation | head -15
echo "========================================="
echo ""

# 9. API í…ŒìŠ¤íŠ¸
log_info "9ë‹¨ê³„: API ë™ì‘ í™•ì¸..."

# ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username": "admin", "password": "Admin123!@#"}' | jq -r '.accessToken' 2>/dev/null)

if [ ! -z "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
    log_success "API Gateway: ì •ìƒ ì‘ë™ âœ…"
    
    # Device API í…ŒìŠ¤íŠ¸
    DEVICES=$(curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/devices | jq '.total' 2>/dev/null)
    if [ ! -z "$DEVICES" ] && [ "$DEVICES" != "null" ]; then
        log_success "Device API: ì •ìƒ ì‘ë™ âœ… (ì¥ë¹„: $DEVICESê°œ)"
    else
        log_warning "Device API: í™•ì¸ í•„ìš”"
    fi
    
    # MCP API í…ŒìŠ¤íŠ¸
    MCP_SERVERS=$(curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/mcp/servers | jq '.total' 2>/dev/null)
    if [ ! -z "$MCP_SERVERS" ] && [ "$MCP_SERVERS" != "null" ]; then
        log_success "MCP API: ì •ìƒ ì‘ë™ âœ… (ì„œë²„: $MCP_SERVERSê°œ)"
    else
        log_warning "MCP API: í™•ì¸ í•„ìš”"
    fi
else
    log_warning "API Gateway ì—°ê²° ëŒ€ê¸° ì¤‘..."
fi

echo ""
echo "========================================="
echo "   âœ… ë³µì› ì™„ë£Œ!"
echo "========================================="
echo ""
echo "ğŸ“Œ ì ‘ì† ì •ë³´:"
echo "  â€¢ Frontend: http://localhost:3001"
echo "  â€¢ API Gateway: http://localhost:8080"
echo "  â€¢ ê³„ì •: admin / Admin123!@#"
echo ""
echo "ğŸ“Š ë³µì›ëœ ë°ì´í„°:"
echo "  â€¢ ì¥ë¹„: ${DEVICES:-í™•ì¸ì¤‘}ê°œ"
echo "  â€¢ MCP ì„œë²„: ${MCP_SERVERS:-í™•ì¸ì¤‘}ê°œ"
echo ""
echo "========================================="
echo ""

# 10. ì¶”ê°€ ê¶Œì¥ì‚¬í•­
if [ "$DEVICES" == "null" ] || [ "$MCP_SERVERS" == "null" ]; then
    echo "âš ï¸  ì¼ë¶€ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤."
    echo "   1-2ë¶„ í›„ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”."
    echo ""
fi

log_success "ì‹œìŠ¤í…œ ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"
