#!/bin/bash
# create-full-backup.sh

set -e
PROJECT_DIR="/Users/leesg/Documents/work_ops/automation-system"
BACKUP_ID="$(date +%Y%m%d_%H%M%S)"
BACKUP_DIR="$PROJECT_DIR/backups/$BACKUP_ID"

echo "ğŸš€ í†µí•© ë°±ì—… ì‹œì‘: $BACKUP_ID"
mkdir -p $BACKUP_DIR/{images,data,schemas}

# 1. ì„œë¹„ìŠ¤ ìƒíƒœ ì €ì¥
echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ ì €ì¥..."
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" | grep automation > $BACKUP_DIR/service-status.txt

# 2. Docker ì´ë¯¸ì§€ ë°±ì—…
echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë°±ì—…..."
cd $BACKUP_DIR/images
for service in gateway storage device-service mcp-service llm-service workflow-engine main-app; do
    echo "  - $service ë°±ì—… ì¤‘..."
    docker save automation-system/$service:latest -o ${service}-$BACKUP_ID.tar &
done
wait

# 3. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ìŠ¤í‚¤ë§ˆ í¬í•¨)
echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…..."
cd $BACKUP_DIR/data

# PostgreSQL - ìŠ¤í‚¤ë§ˆì™€ ë°ì´í„° ë¶„ë¦¬ ë°±ì—…
echo "  - PostgreSQL ìŠ¤í‚¤ë§ˆ ë°±ì—…..."
docker exec automation-postgres pg_dump -U postgres -d automation --schema-only > postgres-schema-$BACKUP_ID.sql

echo "  - PostgreSQL ë°ì´í„° ë°±ì—…..."
docker exec automation-postgres pg_dump -U postgres -d automation --data-only > postgres-data-$BACKUP_ID.sql

# Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë°±ì—…
echo "  - Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë°±ì—…..."
docker exec automation-postgres pg_dump -U postgres -d automation -t _prisma_migrations > prisma-migrations-$BACKUP_ID.sql

# MongoDB ë°±ì—…
echo "  - MongoDB ë°±ì—…..."
docker exec automation-mongodb mongodump --archive --db=automation \
  --username=admin --password=automation_mongo_pass_2024 \
  --authenticationDatabase=admin > mongodb-$BACKUP_ID.archive

# Redis ë°±ì—…
echo "  - Redis ë°±ì—…..."
docker exec automation-redis redis-cli -a automation_redis_pass_2024 --rdb /tmp/redis-backup.rdb
docker cp automation-redis:/tmp/redis-backup.rdb ./redis-$BACKUP_ID.rdb

# 4. Prisma ìŠ¤í‚¤ë§ˆ ë°±ì—…
echo "ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ë°±ì—…..."
cd $BACKUP_DIR/schemas
for service in storage mcp-integration workflow-engine; do
    service_path=""
    case $service in
        "storage")
            service_path="$PROJECT_DIR/services/storage"
            ;;
        "mcp-integration")
            service_path="$PROJECT_DIR/services/domain/mcp"
            ;;
        "workflow-engine")
            service_path="$PROJECT_DIR/services/domain/workflow"
            ;;
    esac
    
    if [ -d "$service_path/prisma" ]; then
        cp -r "$service_path/prisma" "./${service}-prisma"
    fi
done

# 5. í™˜ê²½ ì„¤ì • ë°±ì—…
echo "âš™ï¸  í™˜ê²½ ì„¤ì • ë°±ì—…..."
cd $BACKUP_DIR
cp $PROJECT_DIR/.env .env.backup 2>/dev/null || true
cp $PROJECT_DIR/docker-compose.yml docker-compose.yml.backup

# 6. ë°±ì—… ì •ë³´
cat > $BACKUP_DIR/backup-info.txt << EOF
ë°±ì—… ID: $BACKUP_ID
ë°±ì—… ì‹œê°„: $(date)
ë°±ì—… í¬ê¸°: $(du -sh $BACKUP_DIR | cut -f1)
ì‹œìŠ¤í…œ ë²„ì „: v3.1
Docker ë²„ì „: $(docker --version)
íŠ¹ì´ì‚¬í•­: ìŠ¤í‚¤ë§ˆì™€ ë°ì´í„° ë¶„ë¦¬ ë°±ì—…, Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ í¬í•¨
EOF

# 7. ë³µì› ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
cat > $BACKUP_DIR/restore-full-backup.sh << 'RESTORE_EOF'
#!/bin/bash
# ì™„ì „ ë³µì› ìŠ¤í¬ë¦½íŠ¸

set -e
BACKUP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$BACKUP_DIR")")"

echo "ğŸ”„ ì™„ì „ ë°±ì—… ë³µì› ì‹œì‘: $(basename $BACKUP_DIR)"

# 1. ì‹œìŠ¤í…œ ì¤‘ì§€
echo "ğŸ›‘ ê¸°ì¡´ ì‹œìŠ¤í…œ ì¤‘ì§€..."
cd "$PROJECT_DIR"
docker-compose down

# 2. ì´ë¯¸ì§€ ë³µì›
echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë³µì›..."
cd "$BACKUP_DIR/images"
for tar_file in *.tar; do
    echo "  - $tar_file ë³µì› ì¤‘..."
    docker load -i "$tar_file"
done

# 3. ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘..."
cd "$PROJECT_DIR"
docker-compose up -d postgres mongodb redis

# PostgreSQL ì¤€ë¹„ ëŒ€ê¸°
until docker exec automation-postgres pg_isready -U postgres > /dev/null 2>&1; do
    echo "   PostgreSQL ì¤€ë¹„ ëŒ€ê¸°..."
    sleep 2
done

# 4. PostgreSQL ë³µì› (ìŠ¤í‚¤ë§ˆ â†’ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ ë°ì´í„°)
echo "ğŸ“Š PostgreSQL ë³µì›..."
docker exec automation-postgres psql -U postgres -c "DROP DATABASE IF EXISTS automation;"
docker exec automation-postgres psql -U postgres -c "CREATE DATABASE automation;"

echo "  - ìŠ¤í‚¤ë§ˆ ë³µì›..."
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/data/postgres-schema-"*.sql

echo "  - Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë³µì›..."
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/data/prisma-migrations-"*.sql

echo "  - ë°ì´í„° ë³µì›..."
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/data/postgres-data-"*.sql

# 5. MongoDB ë³µì›
echo "ğŸ“Š MongoDB ë³µì›..."
docker exec -i automation-mongodb mongorestore --archive --db=automation \
  --username=admin --password=automation_mongo_pass_2024 \
  --authenticationDatabase=admin --drop < "$BACKUP_DIR/data/mongodb-"*.archive

# 6. ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘
echo "ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘..."
docker-compose up -d

# 7. í—¬ìŠ¤ì²´í¬
echo "â³ ì‹œìŠ¤í…œ ì•ˆì •í™” ëŒ€ê¸°..."
sleep 30

echo "âœ… ë³µì› ì™„ë£Œ!"
echo "ğŸ“ ì ‘ì†: http://localhost:3001"
echo "ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ê¶Œì¥"
RESTORE_EOF

chmod +x $BACKUP_DIR/restore-full-backup.sh

echo "âœ… ë°±ì—… ì™„ë£Œ!"
echo "ğŸ“ ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo "ğŸ“Š ë°±ì—… í¬ê¸°: $(du -sh $BACKUP_DIR | cut -f1)"
echo "ğŸ”„ ë³µì›: cd $BACKUP_DIR && ./restore-full-backup.sh"
