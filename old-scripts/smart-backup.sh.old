#!/bin/bash

# ========================================
# í†µí•© ìžë™í™” ì‹œìŠ¤í…œ v3.1 - ìŠ¤ë§ˆíŠ¸ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
# Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ë¬¸ì œ í•´ê²° ë²„ì „
# ========================================

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/Users/leesg/Documents/work_ops/automation-system/backups/$TIMESTAMP"
PROJECT_DIR="/Users/leesg/Documents/work_ops/automation-system"

echo "=== ðŸš€ ìŠ¤ë§ˆíŠ¸ ë°±ì—… ì‹œìž‘ (v3.1) ==="
echo "ë°±ì—… ì‹œê°„: $(date)"
echo "ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo ""

# ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p "$BACKUP_DIR"/{images,data,schema,scripts}

# 1. Docker ì´ë¯¸ì§€ ë°±ì—…
echo "ðŸ“¦ 1/6 Docker ì´ë¯¸ì§€ ë°±ì—… ì¤‘..."
cd "$BACKUP_DIR/images"

echo "  - Gateway ë°±ì—…..."
docker save automation-system/gateway:latest -o gateway-$TIMESTAMP.tar

echo "  - Storage ë°±ì—…..."
docker save automation-system/storage:latest -o storage-$TIMESTAMP.tar

echo "  - Device Service ë°±ì—…..."
docker save automation-system/device-service:latest -o device-service-$TIMESTAMP.tar

echo "  - MCP Service ë°±ì—…..."
docker save automation-system/mcp-service:latest -o mcp-service-$TIMESTAMP.tar

echo "  - LLM Service ë°±ì—…..."
docker save automation-system/llm-service:latest -o llm-service-$TIMESTAMP.tar

echo "  - Workflow Engine ë°±ì—…..."
docker save automation-system/workflow-engine:latest -o workflow-engine-$TIMESTAMP.tar

echo "  - Main App ë°±ì—…..."
docker save automation-system/main-app:latest -o main-app-$TIMESTAMP.tar

echo "âœ… Docker ì´ë¯¸ì§€ ë°±ì—… ì™„ë£Œ"
echo ""

# 2. ðŸ”¥ NEW: Prisma ìŠ¤í‚¤ë§ˆ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ë°±ì—…
echo "ðŸŽ¯ 2/6 Prisma ìŠ¤í‚¤ë§ˆ ë°±ì—… ì¤‘..."
cd "$BACKUP_DIR/schema"

# Prisma ìŠ¤í‚¤ë§ˆ íŒŒì¼ ë°±ì—…
cp "$PROJECT_DIR/services/storage/prisma/schema.prisma" "./prisma-schema-$TIMESTAMP.prisma"

# Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬ ë°±ì—…
docker exec automation-postgres pg_dump -U postgres -d automation -t _prisma_migrations > "./prisma-migrations-$TIMESTAMP.sql"

# í˜„ìž¬ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ êµ¬ì¡° ë°±ì—… (DDLë§Œ)
docker exec automation-postgres pg_dump -U postgres -d automation --schema-only > "./database-schema-$TIMESTAMP.sql"

echo "âœ… Prisma ìŠ¤í‚¤ë§ˆ ë°±ì—… ì™„ë£Œ"
echo ""

# 3. ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„° ë°±ì—…
echo "ðŸ—„ï¸ 3/6 ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„° ë°±ì—… ì¤‘..."
cd "$BACKUP_DIR/data"

echo "  - PostgreSQL ë°ì´í„° ë°±ì—…..."
docker exec automation-postgres pg_dump -U postgres automation --data-only > "postgres-data-$TIMESTAMP.sql"

echo "  - PostgreSQL ì „ì²´ ë°±ì—… (ìŠ¤í‚¤ë§ˆ+ë°ì´í„°)..."
docker exec automation-postgres pg_dump -U postgres automation > "postgres-full-$TIMESTAMP.sql"

echo "  - MongoDB ë°±ì—…..."
docker exec automation-mongodb mongodump --archive --db=automation --username=admin --password=automation_mongo_pass_2024 --authenticationDatabase=admin > "mongodb-$TIMESTAMP.archive"

echo "  - Redis ë°±ì—…..."
docker exec automation-redis redis-cli -a automation_redis_pass_2024 --rdb /tmp/redis-backup.rdb
docker cp automation-redis:/tmp/redis-backup.rdb "./redis-$TIMESTAMP.rdb"

echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì™„ë£Œ"
echo ""

# 4. ðŸ”¥ NEW: í™˜ê²½ ì„¤ì • ë° ì„¤ì • íŒŒì¼ ë°±ì—…
echo "âš™ï¸ 4/6 í™˜ê²½ ì„¤ì • ë°±ì—… ì¤‘..."
cd "$BACKUP_DIR/scripts"

# Docker Compose ì„¤ì •
cp "$PROJECT_DIR/docker-compose.yml" "./docker-compose-$TIMESTAMP.yml"

# í™˜ê²½ ë³€ìˆ˜ (ë¯¼ê° ì •ë³´ ì œì™¸)
if [ -f "$PROJECT_DIR/.env" ]; then
    grep -v -E "(PASSWORD|SECRET|KEY|TOKEN)" "$PROJECT_DIR/.env" > "./env-public-$TIMESTAMP.txt" || true
fi

# ì„œë¹„ìŠ¤ ì„¤ì • íŒŒì¼ë“¤
mkdir -p "./configs"
find "$PROJECT_DIR/services" -name "*.json" -o -name "*.yaml" -o -name "*.yml" | while read config_file; do
    relative_path=${config_file#$PROJECT_DIR/}
    mkdir -p "./configs/$(dirname "$relative_path")"
    cp "$config_file" "./configs/$relative_path"
done

echo "âœ… í™˜ê²½ ì„¤ì • ë°±ì—… ì™„ë£Œ"
echo ""

# 5. ðŸ”¥ NEW: ìŠ¤ë§ˆíŠ¸ ë³µì› ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
echo "ðŸ§  5/6 ìŠ¤ë§ˆíŠ¸ ë³µì› ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
cd "$BACKUP_DIR"

cat > "smart-restore.sh" << 'RESTORE_SCRIPT_EOF'
#!/bin/bash

# ========================================
# ìŠ¤ë§ˆíŠ¸ ë³µì› ìŠ¤í¬ë¦½íŠ¸ - Prisma ë™ê¸°í™” í¬í•¨
# ========================================

set -e

BACKUP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$BACKUP_DIR")")"
TIMESTAMP="TIMESTAMP_PLACEHOLDER"

echo "=== ðŸ”„ ìŠ¤ë§ˆíŠ¸ ë³µì› ì‹œìž‘ ==="
echo "ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo "í”„ë¡œì íŠ¸ ìœ„ì¹˜: $PROJECT_DIR"
echo ""

# 1. ì‹œìŠ¤í…œ ì¤‘ì§€
echo "1ï¸âƒ£ ì‹œìŠ¤í…œ ì¤‘ì§€ ì¤‘..."
cd "$PROJECT_DIR"
docker-compose down
echo "âœ… ì‹œìŠ¤í…œ ì¤‘ì§€ ì™„ë£Œ"
echo ""

# 2. Docker ì´ë¯¸ì§€ ë³µì›
echo "2ï¸âƒ£ Docker ì´ë¯¸ì§€ ë³µì› ì¤‘..."
cd "$BACKUP_DIR/images"

for image_file in *.tar; do
    if [ -f "$image_file" ]; then
        echo "  - $image_file ë³µì› ì¤‘..."
        docker load -i "$image_file"
    fi
done
echo "âœ… Docker ì´ë¯¸ì§€ ë³µì› ì™„ë£Œ"
echo ""

# 3. ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œìž‘
echo "3ï¸âƒ£ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œìž‘ ì¤‘..."
cd "$PROJECT_DIR"
docker-compose up -d postgres mongodb redis minio influxdb
sleep 20
echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œìž‘ ì™„ë£Œ"
echo ""

# 4. ðŸ”¥ PostgreSQL í™•ìž¥ ë° ìŠ¤í‚¤ë§ˆ ì„¤ì •
echo "4ï¸âƒ£ PostgreSQL í™•ìž¥ ì„¤ì • ì¤‘..."
docker exec automation-postgres psql -U postgres -d automation -c "
    CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";
    CREATE EXTENSION IF NOT EXISTS citext;
    CREATE EXTENSION IF NOT EXISTS btree_gin;
"
echo "âœ… PostgreSQL í™•ìž¥ ì„¤ì • ì™„ë£Œ"
echo ""

# 5. ðŸ”¥ Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”
echo "5ï¸âƒ£ Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ì¤‘..."
cd "$PROJECT_DIR"

# Storage Service ì‹œìž‘ (Prisma ë™ê¸°í™”ë¥¼ ìœ„í•´)
docker-compose up -d storage
sleep 10

# Prisma DB Push (ìŠ¤í‚¤ë§ˆ ê°•ì œ ë™ê¸°í™”)
echo "  - Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”..."
docker exec automation-storage npx prisma db push --force-reset

# Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬ ë³µì›
echo "  - ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬ ë³µì›..."
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/schema/prisma-migrations-$TIMESTAMP.sql" || true

echo "âœ… Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ì™„ë£Œ"
echo ""

# 6. ë°ì´í„° ë³µì›
echo "6ï¸âƒ£ ë°ì´í„° ë³µì› ì¤‘..."

# PostgreSQL ë°ì´í„°ë§Œ ë³µì› (ìŠ¤í‚¤ë§ˆëŠ” ì´ë¯¸ Prismaë¡œ ìƒì„±ë¨)
echo "  - PostgreSQL ë°ì´í„° ë³µì›..."
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/data/postgres-data-$TIMESTAMP.sql"

# MongoDB ë³µì›
echo "  - MongoDB ë³µì›..."
docker exec -i automation-mongodb mongorestore --archive --db=automation --username=admin --password=automation_mongo_pass_2024 --authenticationDatabase=admin --drop < "$BACKUP_DIR/data/mongodb-$TIMESTAMP.archive"

# Redis ë³µì›
echo "  - Redis ë³µì›..."
docker cp "$BACKUP_DIR/data/redis-$TIMESTAMP.rdb" automation-redis:/tmp/
docker exec automation-redis redis-cli -a automation_redis_pass_2024 FLUSHALL
# RedisëŠ” ìž¬ì‹œìž‘ìœ¼ë¡œ RDB ë¡œë“œ
docker-compose restart redis

echo "âœ… ë°ì´í„° ë³µì› ì™„ë£Œ"
echo ""

# 7. ì „ì²´ ì‹œìŠ¤í…œ ì‹œìž‘
echo "7ï¸âƒ£ ì „ì²´ ì‹œìŠ¤í…œ ì‹œìž‘ ì¤‘..."
docker-compose up -d
sleep 30
echo "âœ… ì „ì²´ ì‹œìŠ¤í…œ ì‹œìž‘ ì™„ë£Œ"
echo ""

# 8. ë³µì› ê²€ì¦
echo "8ï¸âƒ£ ë³µì› ê²€ì¦ ì¤‘..."
echo "  - ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
docker ps --format "table {{.Names}}\t{{.Status}}" | grep automation | head -8

echo "  - API í…ŒìŠ¤íŠ¸..."
sleep 10
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login -H "Content-Type: application/json" -d '{"username": "admin", "password": "Admin123!@#"}' | jq -r '.accessToken')

if [ "$TOKEN" != "null" ] && [ "$TOKEN" != "" ]; then
    echo "âœ… ì¸ì¦: ì„±ê³µ"
    
    DEVICE_COUNT=$(curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/devices | jq -r '.total // 0')
    echo "âœ… ìž¥ë¹„ ìˆ˜: $DEVICE_COUNT"
    
    MCP_COUNT=$(curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/mcp/servers | jq -r '.total // 0')
    echo "âœ… MCP ì„œë²„ ìˆ˜: $MCP_COUNT"
else
    echo "âŒ ì¸ì¦ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
fi

echo ""
echo "ðŸŽ‰ ìŠ¤ë§ˆíŠ¸ ë³µì› ì™„ë£Œ!"
echo ""
echo "ðŸ“ ì ‘ê·¼ URL:"
echo "  - Main Application: http://localhost:3001"
echo "  - API Gateway: http://localhost:8080"
echo ""
echo "ðŸ” ì¶”ê°€ í™•ì¸ì‚¬í•­:"
echo "  - ëŒ€ì‹œë³´ë“œì—ì„œ 5/5 ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
echo "  - ìž¥ë¹„ ë° MCP ì„œë²„ ì •ìƒ ë™ìž‘ í™•ì¸"
echo "  - ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í…ŒìŠ¤íŠ¸"
RESTORE_SCRIPT_EOF

# ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤ì œ íƒ€ìž„ìŠ¤íƒ¬í”„ ì‚½ìž…
sed -i '' "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" "smart-restore.sh"
chmod +x "smart-restore.sh"

echo "âœ… ìŠ¤ë§ˆíŠ¸ ë³µì› ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
echo ""

# 6. ë°±ì—… ë©”íƒ€ë°ì´í„° ìƒì„±
echo "ðŸ“‹ 6/6 ë°±ì—… ë©”íƒ€ë°ì´í„° ìƒì„± ì¤‘..."

cat > "backup-info.md" << BACKUP_INFO_EOF
# ìŠ¤ë§ˆíŠ¸ ë°±ì—… ì •ë³´ v3.1

## ðŸ“¦ ë°±ì—… ê°œìš”
- **ë°±ì—… ì‹œê°„**: $(date)
- **ë°±ì—… ID**: $TIMESTAMP
- **ë°±ì—… íƒ€ìž…**: ì™„ì „ ë°±ì—… (ì´ë¯¸ì§€ + ë°ì´í„° + ìŠ¤í‚¤ë§ˆ)
- **Prisma ë™ê¸°í™”**: í¬í•¨ âœ…

## ðŸ”§ ì£¼ìš” ê°œì„ ì‚¬í•­
1. **Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”**: ë³µì› ì‹œ ìžë™ ì²˜ë¦¬
2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬**: ì™„ì „ ë³´ì¡´
3. **í™˜ê²½ ì„¤ì • ë°±ì—…**: ì„¤ì • íŒŒì¼ í¬í•¨
4. **ìŠ¤ë§ˆíŠ¸ ë³µì›**: í•œ ë²ˆ ì‹¤í–‰ìœ¼ë¡œ ì™„ì „ ë³µì›

## ðŸ“ ë°±ì—… êµ¬ì¡°
\`\`\`
$TIMESTAMP/
â”œâ”€â”€ images/           # Docker ì´ë¯¸ì§€ (7ê°œ)
â”œâ”€â”€ data/            # ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„°
â”œâ”€â”€ schema/          # Prisma ìŠ¤í‚¤ë§ˆ + ë§ˆì´ê·¸ë ˆì´ì…˜
â”œâ”€â”€ scripts/         # í™˜ê²½ ì„¤ì • + ì„¤ì • íŒŒì¼
â”œâ”€â”€ smart-restore.sh # ìŠ¤ë§ˆíŠ¸ ë³µì› ìŠ¤í¬ë¦½íŠ¸ â­
â””â”€â”€ backup-info.md   # ì´ íŒŒì¼
\`\`\`

## ðŸš€ ë³µì› ë°©ë²•

### ì™„ì „ ìžë™ ë³µì› (ê¶Œìž¥)
\`\`\`bash
cd $BACKUP_DIR
./smart-restore.sh
\`\`\`

### íŠ¹ì§•
- âœ… Prisma ìŠ¤í‚¤ë§ˆ ìžë™ ë™ê¸°í™”
- âœ… ë°ì´í„°ë² ì´ìŠ¤ í™•ìž¥ ìžë™ ì„¤ì¹˜
- âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬ ë³µì›
- âœ… ë³µì› í›„ ìžë™ ê²€ì¦
- âœ… ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ ë¬¸ì œ ì™„ì „ í•´ê²°

## ðŸ“Š ë°±ì—… ë‚´ìš©
- **Docker ì´ë¯¸ì§€**: 7ê°œ ì„œë¹„ìŠ¤
- **PostgreSQL**: ìŠ¤í‚¤ë§ˆ + ë°ì´í„° + ë§ˆì´ê·¸ë ˆì´ì…˜
- **MongoDB**: ì „ì²´ ì»¬ë ‰ì…˜
- **Redis**: RDB ìŠ¤ëƒ…ìƒ·
- **Prisma**: ìŠ¤í‚¤ë§ˆ íŒŒì¼ + ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬
- **ì„¤ì •**: Docker Compose + ì„œë¹„ìŠ¤ ì„¤ì •

## âš ï¸ ë³µì› í›„ í™•ì¸ì‚¬í•­
1. ëŒ€ì‹œë³´ë“œ ì ‘ì†: http://localhost:3001
2. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸: 5/5 ì •ìƒ
3. API í…ŒìŠ¤íŠ¸: ìž¥ë¹„, MCP, ì›Œí¬í”Œë¡œìš°
4. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸: ìƒˆ ìž¥ë¹„ ì¶”ê°€, ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

## ðŸ”’ ë³´ì•ˆ ì •ë³´
- í™˜ê²½ ë³€ìˆ˜ ì¤‘ ë¯¼ê° ì •ë³´ëŠ” ì œì™¸ë¨
- ë³µì› í›„ .env íŒŒì¼ ìˆ˜ë™ ì„¤ì • í•„ìš”
- API í‚¤ ë° ë¹„ë°€ë²ˆí˜¸ëŠ” ë³„ë„ ê´€ë¦¬
BACKUP_INFO_EOF

# ë°±ì—… í¬ê¸° ê³„ì‚°
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)

echo "âœ… ë°±ì—… ë©”íƒ€ë°ì´í„° ìƒì„± ì™„ë£Œ"
echo ""

echo "ðŸŽ‰ ìŠ¤ë§ˆíŠ¸ ë°±ì—… ì™„ë£Œ!"
echo ""
echo "ðŸ“Š ë°±ì—… ì •ë³´:"
echo "  - ë°±ì—… ID: $TIMESTAMP"
echo "  - ë°±ì—… í¬ê¸°: $BACKUP_SIZE"
echo "  - ë³µì› ë°©ë²•: ./smart-restore.sh"
echo ""
echo "ðŸ”¥ ì£¼ìš” ê°œì„ ì‚¬í•­:"
echo "  âœ… Prisma ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ìžë™í™”"
echo "  âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ížˆìŠ¤í† ë¦¬ ë³´ì¡´"
echo "  âœ… ì›í´ë¦­ ë³µì› ì§€ì›"
echo "  âœ… ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ ë¬¸ì œ ì™„ì „ í•´ê²°"
echo ""
echo "ðŸ“ ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
