#!/bin/bash

# í†µí•© ìžë™í™” ì‹œìŠ¤í…œ ìžë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

set -e
PROJECT_DIR="/Users/leesg/Documents/work_ops/automation-system"
BACKUP_ID="$(date +%Y%m%d_%H%M%S)"
BACKUP_DIR="$PROJECT_DIR/backups/$BACKUP_ID"

echo "ðŸš€ ìžë™ ë°±ì—… ì‹œìž‘: $BACKUP_ID"
mkdir -p $BACKUP_DIR/{images,data}

# 1. Docker ì´ë¯¸ì§€ ë°±ì—…
echo "ðŸ“¦ Docker ì´ë¯¸ì§€ ë°±ì—… ì¤‘..."
cd $BACKUP_DIR/images

docker save automation-system/gateway:latest -o gateway-$BACKUP_ID.tar &
docker save automation-system/storage:latest -o storage-$BACKUP_ID.tar &
docker save automation-system/device-service:latest -o device-service-$BACKUP_ID.tar &
docker save automation-system/mcp-service:latest -o mcp-service-$BACKUP_ID.tar &
docker save automation-system/llm-service:latest -o llm-service-$BACKUP_ID.tar &
docker save automation-system/main-app:latest -o main-app-$BACKUP_ID.tar &

# ëŒ€ìš©ëŸ‰ ì´ë¯¸ì§€ëŠ” ë³„ë„ ì²˜ë¦¬
docker save automation-system/workflow-engine:latest -o workflow-engine-$BACKUP_ID.tar

wait  # ë³‘ë ¬ ìž‘ì—… ì™„ë£Œ ëŒ€ê¸°

# 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
echo "ðŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì¤‘..."
cd $BACKUP_DIR/data

echo "ë°±ì—… ìƒì„±: $(date)" > backup-info.txt
echo "ë²„ì „: v3.1 (Gateway Health Routes ì¶”ê°€)" >> backup-info.txt
echo "ì£¼ìš” ë³€ê²½: Dashboard ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìƒíƒœ í†µí•©" >> backup-info.txt

# PostgreSQL ë°±ì—…
docker exec automation-postgres pg_dump -U postgres automation > postgres-$BACKUP_ID.sql

# Prisma ìŠ¤í‚¤ë§ˆì™€ ë§ˆì´ê·¸ë ˆì´ì…˜ ë°±ì—…
echo "ðŸ”§ Prisma ìŠ¤í‚¤ë§ˆ ë°±ì—… ì¤‘..."
docker cp automation-storage:/app/prisma $BACKUP_DIR/data/prisma-schema
docker exec automation-storage npx prisma migrate status > $BACKUP_DIR/data/prisma-migration-status.txt

# MongoDB ë°±ì—…
docker exec automation-mongodb mongodump --archive --db=automation \
  --username=admin --password=automation_mongo_pass_2024 \
  --authenticationDatabase=admin > mongodb-$BACKUP_ID.archive

# Redis ë°±ì—… (ì„ íƒì )
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
docker exec automation-redis redis-cli -a automation_redis_pass_2024 --rdb /tmp/redis-backup.rdb
docker cp automation-redis:/tmp/redis-backup.rdb ./redis-$BACKUP_ID.rdb

# 3. ì†ŒìŠ¤ì½”ë“œ ë°±ì—… (ìˆ˜ì •ëœ íŒŒì¼ë“¤)
echo "ðŸ“ ì†ŒìŠ¤ì½”ë“œ ë°±ì—… ì¤‘..."
cd $PROJECT_DIR
tar -czf $BACKUP_DIR/data/source-code-$BACKUP_ID.tar.gz \
  services/core/gateway/src/routes/health.routes.ts \
  services/core/gateway/src/app.ts \
  frontend/main-app/src/pages/DashboardPage.tsx \
  docker-compose.yml \
  .env

# 4. ë³µì› ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
cat > $BACKUP_DIR/restore-backup.sh << 'RESTORE_EOF'
#!/bin/bash
# ìžë™ ìƒì„±ëœ ë³µì› ìŠ¤í¬ë¦½íŠ¸

set -e
BACKUP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$BACKUP_DIR")")"

echo "ðŸ”„ ë°±ì—… ë³µì› ì‹œìž‘: $(basename $BACKUP_DIR)"

# ê¸°ì¡´ ì‹œìŠ¤í…œ ì¤‘ì§€
cd "$PROJECT_DIR"
docker-compose down

# ì´ë¯¸ì§€ ë³µì›
echo "ðŸ“¦ Docker ì´ë¯¸ì§€ ë³µì›..."
cd "$BACKUP_DIR/images"
for tar_file in *.tar; do
    echo "  - $tar_file ë³µì› ì¤‘..."
    docker load -i "$tar_file"
done

# ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œìž‘
echo "ðŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë³µì›..."
cd "$PROJECT_DIR"
docker-compose up -d postgres mongodb redis

sleep 15  # ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°

# PostgreSQL ë³µì›
echo "  - PostgreSQL ë³µì›..."
docker exec automation-postgres psql -U postgres -c "DROP DATABASE IF EXISTS automation;"
docker exec automation-postgres psql -U postgres -c "CREATE DATABASE automation;"
docker exec -i automation-postgres psql -U postgres -d automation < "$BACKUP_DIR/data/postgres-"*.sql

# MongoDB ë³µì›
echo "  - MongoDB ë³µì›..."
docker exec -i automation-mongodb mongorestore --archive --db=automation \
  --username=admin --password=automation_mongo_pass_2024 \
  --authenticationDatabase=admin --drop < "$BACKUP_DIR/data/mongodb-"*.archive

# ì†ŒìŠ¤ì½”ë“œ ë³µì› (ì„ íƒì )
if [ -f "$BACKUP_DIR/data/source-code-"*.tar.gz ]; then
    echo "ðŸ“ ì†ŒìŠ¤ì½”ë“œ ë³µì›..."
    cd "$PROJECT_DIR"
    tar -xzf "$BACKUP_DIR/data/source-code-"*.tar.gz
fi

# ì „ì²´ ì‹œìŠ¤í…œ ì‹œìž‘
echo "ðŸš€ ì‹œìŠ¤í…œ ì‹œìž‘..."
docker-compose up -d postgres mongodb redis minio influxdb kafka zookeeper \
  storage gateway device-service mcp-service llm-service workflow-engine main-app

echo "â³ ì‹œìŠ¤í…œ ì¤€ë¹„ ëŒ€ê¸°..."
sleep 30

# ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”
if [ -f "$PROJECT_DIR/sync-db-schema.sh" ]; then
    echo "ðŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”..."
    cd "$PROJECT_DIR"
    ./sync-db-schema.sh
fi

echo "âœ… ë³µì› ì™„ë£Œ!"
echo "ðŸ“ ì ‘ì†: http://localhost:3001"
echo "ðŸ” Health Check: http://localhost:8080/api/v1/system/health"
RESTORE_EOF

chmod +x $BACKUP_DIR/restore-backup.sh

# 5. ë°±ì—… ì™„ë£Œ ë³´ê³ 
echo "âœ… ë°±ì—… ì™„ë£Œ!"
echo "ðŸ“ ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo "ðŸ“Š ë°±ì—… í¬ê¸°: $(du -sh $BACKUP_DIR | cut -f1)"
echo "ðŸ”„ ë³µì› ëª…ë ¹: cd $BACKUP_DIR && ./restore-backup.sh"

# 6. ë°±ì—… ëª©ë¡ ì—…ë°ì´íŠ¸
echo "ðŸ“‹ ë°±ì—… ëª©ë¡ ì—…ë°ì´íŠ¸..."
cat > $PROJECT_DIR/backups/latest-backup.txt << LATEST_EOF
ìµœì‹  ë°±ì—…: $BACKUP_ID
ìƒì„± ì‹œê°„: $(date)
í¬ê¸°: $(du -sh $BACKUP_DIR | cut -f1)
ìœ„ì¹˜: $BACKUP_DIR
ë³µì›: cd $BACKUP_DIR && ./restore-backup.sh
íŠ¹ì´ì‚¬í•­: Gateway Health Routes ì¶”ê°€, Dashboard ìˆ˜ì • í¬í•¨
LATEST_EOF

echo "ðŸŽ‰ ìžë™ ë°±ì—… ì™„ë£Œ!"
