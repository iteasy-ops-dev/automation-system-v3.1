#!/bin/bash

# ========================================
# ì™„ë²½í•œ ë³µì› ìŠ¤í¬ë¦½íŠ¸ v3.0 - ìµœì¢… ê²€ì¦ ë²„ì „
# ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ ë¬¸ì œ ì™„ì „ í•´ê²°
# ========================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# í•¨ìˆ˜: ë¡œê·¸ ì¶œë ¥
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

log_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

log_debug() {
    echo -e "${CYAN}[DEBUG]${NC} $1"
}

# ë°±ì—… ë””ë ‰í† ë¦¬ ì°¾ê¸°
PROJECT_DIR="/Users/leesg/Documents/work_ops/automation-system"
BACKUP_DIR=""

# ì¸ìë¡œ ë°±ì—… ID ë°›ê¸°
if [ ! -z "$1" ]; then
    if [ -d "$PROJECT_DIR/backups/$1" ]; then
        BACKUP_DIR="$PROJECT_DIR/backups/$1"
        log_info "ì§€ì •ëœ ë°±ì—… ì‚¬ìš©: $1"
    else
        log_error "ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $1"
        exit 1
    fi
else
    # ê²€ì¦ëœ ë°±ì—… ìš°ì„  ì‚¬ìš©
    if [ -d "$PROJECT_DIR/backups/20250804_083504" ]; then
        BACKUP_DIR="$PROJECT_DIR/backups/20250804_083504"
        log_info "ìµœì‹  ê²€ì¦ëœ ë°±ì—… ì‚¬ìš©: 20250804_083504"
    elif [ -d "$PROJECT_DIR/backups/20250802_165334" ]; then
        BACKUP_DIR="$PROJECT_DIR/backups/20250802_165334"
        log_info "ê²€ì¦ëœ ë°±ì—… ì‚¬ìš©: 20250802_165334"
    else
        # ê°€ì¥ ìµœê·¼ ë°±ì—… ì°¾ê¸°
        BACKUP_DIR=$(ls -dt $PROJECT_DIR/backups/202* 2>/dev/null | head -1)
        if [ -z "$BACKUP_DIR" ]; then
            log_error "ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
        fi
        log_warning "ìµœê·¼ ë°±ì—… ì‚¬ìš©: $(basename $BACKUP_DIR)"
    fi
fi

echo ""
echo "========================================="
echo "   ğŸ”„ ì™„ë²½í•œ ì‹œìŠ¤í…œ ë³µì› v3.0"
echo "========================================="
echo "ë°±ì—…: $(basename $BACKUP_DIR)"
echo "ìœ„ì¹˜: $BACKUP_DIR"
echo "========================================="
echo ""

# ì‚¬ì „ ê²€ì¦
log_info "ì‚¬ì „ ê²€ì¦ ì‹œì‘..."

# Docker ì‹¤í–‰ í™•ì¸
if ! docker info > /dev/null 2>&1; then
    log_error "Dockerê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
    exit 1
fi

# ë°±ì—… íŒŒì¼ í™•ì¸
if [ ! -d "$BACKUP_DIR/images" ] || [ ! -d "$BACKUP_DIR/data" ]; then
    log_error "ë°±ì—… íŒŒì¼ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤!"
    exit 1
fi

log_success "ì‚¬ì „ ê²€ì¦ ì™„ë£Œ"
echo ""

# 1. ì‹œìŠ¤í…œ ì™„ì „ ì¤‘ì§€
log_info "1ë‹¨ê³„: ê¸°ì¡´ ì‹œìŠ¤í…œ ì™„ì „ ì¤‘ì§€..."
cd "$PROJECT_DIR"
docker-compose down 2>/dev/null || true
docker-compose down -v 2>/dev/null || true  # ë³¼ë¥¨ë„ ì œê±° (ê¹¨ë—í•œ ì‹œì‘)
log_success "ì‹œìŠ¤í…œ ì¤‘ì§€ ì™„ë£Œ"
echo ""

# 2. Docker ì´ë¯¸ì§€ ë³µì›
log_info "2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë³µì›..."
cd "$BACKUP_DIR/images"
IMAGE_COUNT=0
for image_file in *.tar; do
    if [ -f "$image_file" ]; then
        echo "  â†’ $image_file ë³µì› ì¤‘..."
        docker load -i "$image_file" > /dev/null 2>&1
        IMAGE_COUNT=$((IMAGE_COUNT + 1))
    fi
done
log_success "Docker ì´ë¯¸ì§€ ë³µì› ì™„ë£Œ ($IMAGE_COUNTê°œ)"
echo ""

# 3. ë„¤íŠ¸ì›Œí¬ ìƒì„±
log_info "3ë‹¨ê³„: Docker ë„¤íŠ¸ì›Œí¬ ì¤€ë¹„..."
cd "$PROJECT_DIR"
docker network create automation-data 2>/dev/null || true
docker network create automation-backend 2>/dev/null || true
docker network create automation-frontend 2>/dev/null || true
log_success "ë„¤íŠ¸ì›Œí¬ ì¤€ë¹„ ì™„ë£Œ"
echo ""

# 4. ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
log_info "4ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘..."
docker-compose up -d postgres mongodb redis minio influxdb
echo "  ëŒ€ê¸° ì¤‘..."
sleep 20  # ì¶©ë¶„í•œ ì‹œì‘ ì‹œê°„ í™•ë³´
log_success "ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
echo ""

# 5. PostgreSQL ì´ˆê¸°í™”
log_info "5ë‹¨ê³„: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”..."

# ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ ë° ì¬ìƒì„±
docker exec automation-postgres psql -U postgres << 'EOF' 2>/dev/null || true
DROP DATABASE IF EXISTS automation;
CREATE DATABASE automation;
EOF

# í•„ìˆ˜ í™•ì¥ ì„¤ì¹˜ (ìˆœì„œ ì¤‘ìš”!)
log_debug "PostgreSQL í™•ì¥ ì„¤ì¹˜..."
docker exec automation-postgres psql -U postgres -d automation << 'EOF'
-- í•„ìˆ˜ í™•ì¥ ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS btree_gin;

-- í™•ì¥ í™•ì¸
SELECT extname, extversion FROM pg_extension WHERE extname IN ('uuid-ossp', 'citext', 'btree_gin');
EOF

log_success "PostgreSQL ì´ˆê¸°í™” ì™„ë£Œ"
echo ""

# 6. ë°±ì—… ë°ì´í„° ë³µì›
log_info "6ë‹¨ê³„: ë°±ì—… ë°ì´í„° ë³µì›..."

# PostgreSQL ë°ì´í„° ë³µì›
PG_BACKUP=$(ls $BACKUP_DIR/data/postgres-full-*.sql 2>/dev/null | head -1)
if [ -f "$PG_BACKUP" ]; then
    log_debug "PostgreSQL ë°ì´í„° ë³µì› ì¤‘..."
    cat "$PG_BACKUP" | docker exec -i automation-postgres psql -U postgres -d automation 2>&1 | grep -E "ERROR|NOTICE" | head -5 || true
    log_success "PostgreSQL ë°ì´í„° ë³µì› ì™„ë£Œ"
else
    log_warning "PostgreSQL ë°±ì—… íŒŒì¼ ì—†ìŒ"
fi

# MongoDB ë°ì´í„° ë³µì›
MONGO_BACKUP=$(ls $BACKUP_DIR/data/mongodb-*.archive 2>/dev/null | head -1)
if [ -f "$MONGO_BACKUP" ]; then
    log_debug "MongoDB ë°ì´í„° ë³µì› ì¤‘..."
    docker exec -i automation-mongodb mongorestore --archive --db=automation \
        --username=admin --password=automation_mongo_pass_2024 \
        --authenticationDatabase=admin --drop < "$MONGO_BACKUP" 2>&1 | grep -E "done dumping|finished" || true
    log_success "MongoDB ë°ì´í„° ë³µì› ì™„ë£Œ"
else
    log_warning "MongoDB ë°±ì—… íŒŒì¼ ì—†ìŒ"
fi

echo ""

# 7. ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” (ê°€ì¥ ì¤‘ìš”!)
log_info "7ë‹¨ê³„: Prisma-DB ìŠ¤í‚¤ë§ˆ ì™„ì „ ë™ê¸°í™”..."

log_debug "ëˆ„ë½ëœ ì»¬ëŸ¼ ì¶”ê°€ ì¤‘..."
docker exec automation-postgres psql -U postgres -d automation << 'EOF'
-- ========== devices í…Œì´ë¸” ==========
ALTER TABLE devices ADD COLUMN IF NOT EXISTS connection_info jsonb DEFAULT '{}'::jsonb;

-- ========== mcp_servers í…Œì´ë¸” ==========
-- Transport ê´€ë ¨
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS transport VARCHAR(20) DEFAULT 'stdio';
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS connection_status VARCHAR(20) DEFAULT 'disconnected';

-- ì‹¤í–‰ ê´€ë ¨
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS command VARCHAR(500);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS args TEXT[] DEFAULT ARRAY[]::TEXT[];

-- ì„¤ì • ê´€ë ¨
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS ssh_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS docker_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS http_config JSONB;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS server_info JSONB;

-- ìƒíƒœ ê´€ë ¨
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_error TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS environment JSONB DEFAULT '{}'::jsonb;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}'::jsonb;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS last_connected_at TIMESTAMP(6);
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS error_message TEXT;
ALTER TABLE mcp_servers ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;

-- ========== ê´€ë ¨ í…Œì´ë¸” ìƒì„± ==========
-- mcp_tools í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS mcp_tools (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    server_id UUID NOT NULL REFERENCES mcp_servers(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    input_schema jsonb DEFAULT '{}'::jsonb,
    output_schema jsonb DEFAULT '{}'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(server_id, name)
);

-- mcp_executions í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS mcp_executions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    server_id UUID NOT NULL REFERENCES mcp_servers(id) ON DELETE CASCADE,
    tool_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    input_params jsonb DEFAULT '{}'::jsonb,
    output_result jsonb,
    error_message TEXT,
    started_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP(6),
    duration_ms INTEGER,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by UUID,
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤ ìƒì„± (ëˆ„ë½ëœ ê²½ìš°)
CREATE INDEX IF NOT EXISTS idx_mcp_executions_server_id ON mcp_executions(server_id);
CREATE INDEX IF NOT EXISTS idx_mcp_executions_status ON mcp_executions(status);
CREATE INDEX IF NOT EXISTS idx_mcp_tools_server_id ON mcp_tools(server_id);

-- ê²°ê³¼ í™•ì¸
SELECT 
    'devices' as table_name, 
    COUNT(*) as column_count 
FROM information_schema.columns 
WHERE table_name = 'devices' AND table_schema = 'public'
UNION ALL
SELECT 
    'mcp_servers' as table_name, 
    COUNT(*) as column_count 
FROM information_schema.columns 
WHERE table_name = 'mcp_servers' AND table_schema = 'public';
EOF

log_success "ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ì™„ë£Œ"
echo ""

# 8. Storage ì„œë¹„ìŠ¤ ì‹œì‘ (Prisma ì´ˆê¸°í™”)
log_info "8ë‹¨ê³„: Storage ì„œë¹„ìŠ¤ ì‹œì‘..."
cd "$PROJECT_DIR"
docker-compose up -d storage
sleep 10

# Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±
log_debug "Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±..."
docker exec automation-storage npx prisma generate 2>&1 | grep -E "Generated|Error" || true

log_success "Storage ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"
echo ""

# 9. ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ ì‹œì‘
log_info "9ë‹¨ê³„: ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘..."

# Kafka/Zookeeper
docker-compose up -d zookeeper kafka
sleep 10

# Gateway
docker-compose up -d gateway
sleep 5

# Domain ì„œë¹„ìŠ¤ë“¤
docker-compose up -d device-service mcp-service llm-service workflow-engine
sleep 10

# Frontend
docker-compose up -d main-app

log_success "ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
echo ""

# 10. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
log_info "10ë‹¨ê³„: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
sleep 15  # ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°

echo ""
echo "========================================="
echo "   ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ"
echo "========================================="
docker ps --format "table {{.Names}}\t{{.Status}}" | grep automation | head -20
echo "========================================="
echo ""

# 11. API ë™ì‘ í™•ì¸
log_info "11ë‹¨ê³„: API ë™ì‘ í™•ì¸..."

# ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username": "admin", "password": "Admin123!@#"}' 2>/dev/null | jq -r '.accessToken')

if [ ! -z "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
    log_success "âœ… API Gateway: ì •ìƒ ì‘ë™"
    
    # Device API í…ŒìŠ¤íŠ¸
    DEVICES=$(curl -s -H "Authorization: Bearer $TOKEN" \
        http://localhost:8080/api/v1/devices 2>/dev/null | jq '.total')
    if [ ! -z "$DEVICES" ] && [ "$DEVICES" != "null" ]; then
        log_success "âœ… Device API: ì •ìƒ ì‘ë™ (ì¥ë¹„: $DEVICESê°œ)"
    else
        log_warning "âš ï¸ Device API: ì‹œì‘ ì¤‘..."
    fi
    
    # MCP API í…ŒìŠ¤íŠ¸
    MCP_SERVERS=$(curl -s -H "Authorization: Bearer $TOKEN" \
        http://localhost:8080/api/v1/mcp/servers 2>/dev/null | jq '.total')
    if [ ! -z "$MCP_SERVERS" ] && [ "$MCP_SERVERS" != "null" ]; then
        log_success "âœ… MCP API: ì •ìƒ ì‘ë™ (ì„œë²„: $MCP_SERVERSê°œ)"
    else
        log_warning "âš ï¸ MCP API: ì‹œì‘ ì¤‘..."
    fi
else
    log_warning "âš ï¸ API Gateway: ì‹œì‘ ì¤‘..."
fi

echo ""
echo "========================================="
echo "   âœ… ë³µì› ì™„ë£Œ!"
echo "========================================="
echo ""
echo "ğŸ“Œ ì ‘ì† ì •ë³´:"
echo "  â€¢ Frontend: http://localhost:3001"
echo "  â€¢ API Gateway: http://localhost:8080"
echo "  â€¢ ê³„ì •: admin / Admin123!@#"
echo ""
echo "ğŸ“Š ë³µì›ëœ ë°ì´í„°:"
echo "  â€¢ Docker ì´ë¯¸ì§€: $IMAGE_COUNTê°œ"
echo "  â€¢ ì¥ë¹„: ${DEVICES:-í™•ì¸ì¤‘}ê°œ"
echo "  â€¢ MCP ì„œë²„: ${MCP_SERVERS:-í™•ì¸ì¤‘}ê°œ"
echo ""
echo "========================================="
echo ""

# 12. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ
if [ "$DEVICES" == "null" ] || [ "$MCP_SERVERS" == "null" ]; then
    echo "âš ï¸  ì¼ë¶€ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤."
    echo ""
    echo "ğŸ“ í™•ì¸ ë°©ë²•:"
    echo "  1. 1-2ë¶„ í›„ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸"
    echo "  2. docker ps ë¡œ ìƒíƒœ í™•ì¸"
    echo "  3. docker logs automation-[service-name] ë¡œ ë¡œê·¸ í™•ì¸"
    echo ""
fi

# 13. ìµœì¢… ê²€ì¦
log_info "ìµœì¢… ê²€ì¦..."

# ì¤‘ìš” í…Œì´ë¸” ì¡´ì¬ í™•ì¸
TABLES=$(docker exec automation-postgres psql -U postgres -d automation -t -c \
    "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")

if [ $TABLES -gt 10 ]; then
    log_success "ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”: $TABLESê°œ í™•ì¸"
else
    log_warning "ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìˆ˜ê°€ ì˜ˆìƒë³´ë‹¤ ì ìŠµë‹ˆë‹¤: $TABLESê°œ"
fi

# ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìˆ˜
RUNNING=$(docker ps | grep automation | wc -l)
log_success "ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤: $RUNNINGê°œ"

echo ""
log_success "ğŸ‰ ì‹œìŠ¤í…œ ë³µì›ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo ""
echo "ğŸ’¡ íŒ: ë¬¸ì œê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ë¡œê·¸ í™•ì¸:"
echo "  docker logs -f automation-[service-name]"
echo ""
